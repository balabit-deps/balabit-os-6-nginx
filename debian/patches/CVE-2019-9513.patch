Backport of:

From 39bb3b9d4a33bd03c8ae0134dedc8a7700ae7b2b Mon Sep 17 00:00:00 2001
From: Ruslan Ermilov <ru@nginx.com>
Date: Tue, 13 Aug 2019 15:43:40 +0300
Subject: [PATCH] HTTP/2: limited number of PRIORITY frames.

Fixed excessive CPU usage caused by a peer that continuously shuffles
priority of streams.  Fix is to limit the number of PRIORITY frames.
---
 src/http/v2/ngx_http_v2.c | 10 ++++++++++
 src/http/v2/ngx_http_v2.h |  1 +
 2 files changed, 11 insertions(+)

Index: nginx-1.10.3/src/http/v2/ngx_http_v2.c
===================================================================
--- nginx-1.10.3.orig/src/http/v2/ngx_http_v2.c	2019-08-14 14:47:04.784462370 -0400
+++ nginx-1.10.3/src/http/v2/ngx_http_v2.c	2019-08-14 14:47:47.468819588 -0400
@@ -247,6 +247,8 @@ ngx_http_v2_init(ngx_event_t *rev)
 
     h2scf = ngx_http_get_module_srv_conf(hc->conf_ctx, ngx_http_v2_module);
 
+    h2c->priority_limit = h2scf->concurrent_streams;
+
     h2c->pool = ngx_create_pool(h2scf->pool_size, h2c->connection->log);
     if (h2c->pool == NULL) {
         ngx_http_close_connection(c);
@@ -1782,6 +1784,13 @@ ngx_http_v2_state_priority(ngx_http_v2_c
         return ngx_http_v2_connection_error(h2c, NGX_HTTP_V2_SIZE_ERROR);
     }
 
+    if (--h2c->priority_limit == 0) {
+        ngx_log_error(NGX_LOG_INFO, h2c->connection->log, 0,
+                      "client sent too many PRIORITY frames");
+
+        return ngx_http_v2_connection_error(h2c, NGX_HTTP_V2_ENHANCE_YOUR_CALM);
+    }
+
     if (end - pos < NGX_HTTP_V2_PRIORITY_SIZE) {
         return ngx_http_v2_state_save(h2c, pos, end,
                                       ngx_http_v2_state_priority);
@@ -2840,6 +2849,8 @@ ngx_http_v2_create_stream(ngx_http_v2_co
 
     h2c->processing++;
 
+    h2c->priority_limit += h2scf->concurrent_streams;
+
     return stream;
 }
 
Index: nginx-1.10.3/src/http/v2/ngx_http_v2.h
===================================================================
--- nginx-1.10.3.orig/src/http/v2/ngx_http_v2.h	2019-08-14 14:47:04.784462370 -0400
+++ nginx-1.10.3/src/http/v2/ngx_http_v2.h	2019-08-14 14:47:04.780462336 -0400
@@ -117,6 +117,7 @@ struct ngx_http_v2_connection_s {
     ngx_uint_t                       processing;
     ngx_uint_t                       frames;
     ngx_uint_t                       idle;
+    ngx_uint_t                       priority_limit;
 
     size_t                           send_window;
     size_t                           recv_window;
